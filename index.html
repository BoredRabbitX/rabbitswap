<script>
    // ... (Mantieni tutta la parte grafica e CSS della 1.1.5) ...

    async function executeAdvancedSwap() {
        const val = document.getElementById('swap-in').value;
        if(!val || val <= 0) return dbg("INPUT_REQUIRED");

        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            
            // 1. DEFINIZIONE CONTRATTI
            const hopContract = new ethers.Contract(
                safeAddr(HOP_RAW), 
                ["function approve(address spender, uint256 amount) public returns (bool)", "function allowance(address owner, address spender) view returns (uint256)"], 
                signer
            );
            
            const swapContract = new ethers.Contract(
                safeAddr(SWAP_RAW), 
                ["function swapHOPxforRABx(uint256 _amount) external"], 
                signer
            );

            const amountWei = ethers.utils.parseEther(val.toString());

            // 2. CONTROLLO ALLOWANCE (Per evitare approve inutili)
            dbg("CHECKING_AUTHORIZATION...");
            const currentAllowance = await hopContract.allowance(userAddr, safeAddr(SWAP_RAW));
            
            if (currentAllowance.lt(amountWei)) {
                dbg("REQUESTING_METAMASK_APPROVE...");
                // Forziamo il gas limit per l'approve
                const txApprove = await hopContract.approve(safeAddr(SWAP_RAW), amountWei, { gasLimit: 100000 });
                dbg("APPROVE_PENDING: " + txApprove.hash.substring(0,10));
                await txApprove.wait();
                dbg("AUTH_GRANTED");
            }

            // 3. ESECUZIONE SWAP EFFETTIVO
            dbg("EXECUTING_WALLET_SWAP...");
            // Forziamo il gas limit per lo swap
            const txSwap = await swapContract.swapHOPxforRABx(amountWei, { gasLimit: 300000 });
            dbg("SWAP_PENDING: " + txSwap.hash.substring(0,10));
            await txSwap.wait();
            
            dbg("CONVERSION_COMPLETE_WALLET_UPDATED");
            refreshBalances();
        } catch (e) { 
            console.error(e);
            dbg("SWAP_FAIL: " + (e.reason || "Check PAS for Gas")); 
        }
    }
</script>
