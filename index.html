<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RabbitSwap | RABx Terminal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --fg: #ffffff; --accent: #e6007a; --border: #222; --admin: #ffcc00; }
        body { background: var(--bg); color: var(--fg); font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 400px; padding: 25px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 16px; border-top: 4px solid var(--accent); position: relative; overflow: hidden; }
        h1 { font-family: 'Unbounded'; font-size: 1.2rem; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 2px; }
        .box { background: #000; border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        label { font-size: 0.6rem; color: #666; text-transform: uppercase; display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
        input { background: transparent; border: none; color: white; font-family: 'Unbounded'; font-size: 1.1rem; width: 100%; outline: none; }
        .btn { font-family: 'Unbounded'; background: var(--fg); color: var(--bg); border: none; padding: 16px; font-size: 0.7rem; font-weight: 700; border-radius: 8px; cursor: pointer; width: 100%; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: var(--accent); color: white; transform: translateY(-2px); }
        .btn-swap { background: var(--accent); color: white; }
        #admin-panel { margin-top: 25px; padding-top: 20px; border-top: 1px dashed #333; display: none; }
        .admin-title { color: var(--admin); font-size: 0.65rem; font-family: 'JetBrains Mono'; margin-bottom: 10px; display: block; }
        .status { font-family: 'JetBrains Mono'; font-size: 0.6rem; color: #555; text-align: center; margin-top: 20px; text-transform: uppercase; }
        .bal { color: var(--accent); cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>RabbitSwap <span style="font-size: 0.6rem; color: var(--accent);">v0.0.3</span></h1>
    
    <div id="auth">
        <button class="btn" onclick="connect()">Link Terminal (MetaMask)</button>
    </div>

    <div id="swap-ui" style="display:none;">
        <div class="box">
            <label>Invia HOPx <span class="bal" onclick="setMax()">Max: <span id="hop-bal">0.00</span></span></label>
            <input type="number" id="in-hop" placeholder="0.0" oninput="updateOut(this.value)">
        </div>
        <div style="text-align:center; font-size: 0.8rem; margin: -5px 0 5px 0; color: #333;">↓ 1:200 RATE ↓</div>
        <div class="box">
            <label>Ricevi RABx</label>
            <input type="number" id="out-rab" placeholder="0.0" readonly>
        </div>
        <button class="btn" id="btn-approve" onclick="approve()">1. Autorizza HOPx</button>
        <button class="btn btn-swap" id="btn-swap" onclick="swap()" style="display:none;">2. Esegui Swap</button>
    </div>

    <div id="admin-panel">
        <span class="admin-title">▲ ADMIN PRIVILEGES DETECTED</span>
        <div class="box" style="border-color: var(--admin);">
            <label style="color: var(--admin);">MINTA RABx NEL POOL</label>
            <input type="number" id="mint-amt" placeholder="Quantità..." style="font-size: 0.9rem;">
        </div>
        <button class="btn" style="background: var(--admin); color: black;" onclick="adminMint()">Crea Nuovi Token</button>
    </div>

    <div id="status" class="status">SISTEMA_OFFLINE</div>
</div>

<script>
    const HOP_ADDR = "0xFf7FBB044170C855527735F08443A3e74C9E5580";
    const SWAP_ADDR = "0xc9af70a2cf987a19d3b5d0f7056a516bc8d9ed69";
    const OWNER = "0xa036B32c86E2aB7F2AdE9ACC15984B2A2DDe8977";

    let provider, signer, hopCtx, swapCtx, user, rawBal = "0";

    async function connect() {
        if (!window.ethereum) return setStatus("METAMASK_NON_TROVATO");
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        user = await signer.getAddress();
        
        hopCtx = new ethers.Contract(HOP_ADDR, [
            "function approve(address,uint256) returns (bool)",
            "function balanceOf(address) view returns (uint256)"
        ], signer);
        
        swapCtx = new ethers.Contract(SWAP_ADDR, [
            "function swapHOPxforRABx(uint256)",
            "function mintRABx(uint256)"
        ], signer);

        document.getElementById('auth').style.display = 'none';
        document.getElementById('swap-ui').style.display = 'block';
        
        // Controlla se l'utente è l'owner
        if(user.toLowerCase() === OWNER.toLowerCase()) {
            document.getElementById('admin-panel').style.display = 'block';
        }
        
        updateBalances();
        setStatus("SISTEMA_ONLINE // " + user.substring(0,10));
    }

    async function updateBalances() {
        try {
            const b = await hopCtx.balanceOf(user);
            rawBal = b;
            document.getElementById('hop-bal').innerText = parseFloat(ethers.utils.formatEther(b)).toFixed(2);
        } catch(e) { console.error(e); }
    }

    function updateOut(v) { 
        document.getElementById('out-rab').value = v ? (v * 200).toLocaleString() : ""; 
    }

    async function approve() {
        try {
            const v = document.getElementById('in-hop').value;
            if(!v || v <= 0) return setStatus("INSERIRE_QUANTITA");
            setStatus("ATTESA_AUTORIZZAZIONE...");
            const tx = await hopCtx.approve(SWAP_ADDR, ethers.utils.parseEther(v));
            await tx.wait();
            document.getElementById('btn-approve').style.display = 'none';
            document.getElementById('btn-swap').style.display = 'block';
            setStatus("AUTORIZZATO_OK");
        } catch(e) { setStatus("ERRORE_APPROVE"); }
    }

    async function swap() {
        try {
            setStatus("SCAMBIO_IN_CORSO...");
            const v = document.getElementById('in-hop').value;
            const tx = await swapCtx.swapHOPxforRABx(ethers.utils.parseEther(v), {gasLimit: 300000});
            await tx.wait();
            setStatus("SWAP_COMPLETATO!");
            setTimeout(() => location.reload(), 2500);
        } catch(e) { setStatus("ERRORE_SWAP"); }
    }

    async function adminMint() {
        try {
            const v = document.getElementById('mint-amt').value;
            setStatus("MINTING_IN_CORSO...");
            const tx = await swapCtx.mintRABx(ethers.utils.parseEther(v));
            await tx.wait();
            setStatus("MINT_RIUSCITO: " + v + " RABx");
        } catch(e) { setStatus("ERRORE_MINT"); }
    }

    function setMax() { 
        const v = ethers.utils.formatEther(rawBal);
        document.getElementById('in-hop').value = v; 
        updateOut(v); 
    }
    
    function setStatus(m) { document.getElementById('status').innerText = m; }
</script>
</body>
</html>
