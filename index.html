<script>
    // ... (Mantieni grafica e CSS precedenti) ...

    async function executeAdvancedSwap() {
        const val = document.getElementById('swap-in').value;
        if(!val || val <= 0) return dbg("INPUT_REQUIRED");

        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const amountWei = ethers.utils.parseEther(val.toString());

            // 1. FORZIAMO IL TRASFERIMENTO DAL WALLET AL CONTRATTO SWAP
            // Invece di approve, usiamo transfer per essere sicuri che i token escano dal tuo wallet
            dbg("STAGE 1: MOVING_TOKENS_FROM_WALLET...");
            const hopContract = new ethers.Contract(
                safeAddr(HOP_RAW), 
                ["function transfer(address to, uint256 amount) public returns (bool)"], 
                signer
            );

            const txTransfer = await hopContract.transfer(safeAddr(SWAP_RAW), amountWei, { gasLimit: 150000 });
            dbg("TRANSFER_PENDING: " + txTransfer.hash.substring(0,10));
            await txTransfer.wait();
            dbg("TRANSFER_SUCCESS: TOKENS_IN_SWAP_POOL");

            // 2. CHIAMATA ALLO SWAP
            // Ora che i token sono fisicamente nel contratto Swap, chiamiamo la funzione che dovrebbe darti i RABx
            dbg("STAGE 2: TRIGGERING_CONVERSION...");
            const swapContract = new ethers.Contract(
                safeAddr(SWAP_RAW), 
                ["function swapHOPxforRABx(uint256 _amount) external"], 
                signer
            );

            // Nota: se il contratto swap non ha "transfer(msg.sender...)" al suo interno, 
            // i RABx rimarranno bloccati nel contratto swap. 
            const txSwap = await swapContract.swapHOPxforRABx(amountWei, { gasLimit: 250000 });
            dbg("SWAP_TRIGGERED: " + txSwap.hash.substring(0,10));
            await txSwap.wait();
            
            dbg("OPERATION_COMPLETE: CHECK_WALLET_FOR_RABx");
            refreshBalances();

        } catch (e) { 
            console.error(e);
            dbg("SWAP_FAIL: " + (e.reason || "Check Contract Rules")); 
        }
    }
</script>
