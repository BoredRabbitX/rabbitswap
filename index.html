<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rabbit Swap X | Alpha 1.1.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030303; --fg: #ffffff; --accent: #e6007a; --border: #1a1a1a; --card: rgba(10, 10, 10, 0.8); }
        body { background: var(--bg); color: var(--fg); font-family: 'Inter', sans-serif; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; overflow-x: hidden; }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; pointer-events: none; }
        
        .container { width: 100%; max-width: 950px; padding: 20px; z-index: 1; }
        h1 { font-family: 'Unbounded', sans-serif; font-size: 2.8rem; margin: 0; text-transform: uppercase; letter-spacing: -3px; }
        .tagline { font-size: 0.7rem; color: var(--accent); letter-spacing: 4px; margin-bottom: 40px; text-transform: uppercase; opacity: 0.8; }

        #setup-screen { max-width: 400px; margin: 0 auto; background: var(--card); padding: 40px; border: 1px solid var(--border); border-radius: 12px; backdrop-filter: blur(20px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .dual-grid { display: none; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 768px) { .dual-grid { grid-template-columns: 1fr; } }

        .module { background: var(--card); border: 1px solid var(--border); padding: 30px; border-radius: 12px; backdrop-filter: blur(15px); position: relative; overflow: hidden; }
        .module::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: var(--accent); }
        .module-label { font-size: 0.6rem; color: #555; text-transform: uppercase; font-weight: 700; letter-spacing: 2px; margin-bottom: 20px; display: block; }

        .btn { font-family: 'Inter', sans-serif; background: var(--fg); color: var(--bg); border: none; padding: 18px; font-size: 0.8rem; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; border-radius: 6px; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,255,255,0.1); }
        .btn-outline { background: transparent; color: var(--fg); border: 1px solid #333; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
        .btn-max { background: var(--accent); color: #fff; border: none; padding: 4px 10px; font-size: 9px; border-radius: 4px; cursor: pointer; margin-left: 8px; vertical-align: middle; }

        .swap-box { background: rgba(0,0,0,0.4); border: 1px solid #151515; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .swap-input { background: transparent; border: none; color: #fff; font-size: 1.5rem; width: 100%; outline: none; font-family: 'Unbounded'; margin-top: 10px; }
        .swap-input::placeholder { color: #222; }

        /* POH UI */
        #poh-container { display: none; margin-top: 20px; }
        .poh-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .poh-cell { background: #111; border: 1px solid #222; padding: 12px; cursor: pointer; font-size: 1.4rem; border-radius: 8px; transition: 0.2s; text-align: center; }
        .poh-cell:hover { background: #1a1a1a; border-color: var(--accent); }
        .target-seq { font-family: 'Unbounded'; font-size: 0.9rem; color: var(--accent); background: #111; padding: 10px; border-radius: 6px; text-align: center; border: 1px dashed #333; }

        #debug-console { font-size: 10px; color: #444; font-family: monospace; text-align: left; margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; max-height: 80px; overflow-y: auto; }
        .f-left, .f-right { position: fixed; bottom: 20px; font-family: 'Unbounded'; font-size: 9px; color: #333; letter-spacing: 1px; }
        .f-left { left: 30px; } .f-right { right: 30px; color: var(--accent); }
        
        #countdown-box { color: #ff3e3e; font-family: 'Unbounded'; font-size: 0.8rem; text-align: center; display: none; padding: 10px; border: 1px solid #300; border-radius: 6px; }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="f-left">ESTABLISHED // ALPHA 1.1.5</div>
<div class="f-right">PASEO ASSET HUB PROTOCOL</div>

<div class="container">
    <center>
        <h1>Rabbit Swap X</h1>
        <div class="tagline">Neural Network Extraction</div>
    </center>

    <div id="setup-screen">
        <button class="btn" style="margin-bottom: 15px;" onclick="forceNetwork()">1. Sync Network</button>
        <button class="btn btn-outline" onclick="forceConnect()">2. Link Terminal</button>
    </div>

    <div id="terminal-screen" class="dual-grid">
        <div class="module">
            <span class="module-label">Module_01 // Extraction</span>
            
            <button class="btn" id="btn-main-action" onclick="handleClaimState()">Claim your HOPx</button>
            
            <div id="countdown-box"></div>

            <div id="poh-container">
                <div style="font-size: 9px; color: #444; margin-bottom: 8px; text-transform: uppercase;">Proof of Humanity Required:</div>
                <div class="target-seq" id="poh-display">----</div>
                <div class="poh-grid" id="poh-grid"></div>
            </div>

            <button class="btn" id="btn-final-claim" style="display:none; background: var(--accent); color: white;" onclick="manualClaim()">Execute Extraction</button>
        </div>

        <div class="module">
            <span class="module-label">Module_02 // Liquidity</span>
            
            <div class="swap-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 10px; color: #555;" id="label-from">FROM: HOPx</span>
                    <span style="font-size: 10px; color: #555;">Bal: <span id="bal-from" style="color:var(--accent)">0.00</span> <button class="btn-max" onclick="setMax()">MAX</button></span>
                </div>
                <input type="number" class="swap-input" id="swap-in" placeholder="0.0" oninput="updateEstimate(this.value)">
            </div>

            <div style="text-align: center; margin: -15px 0; position: relative; z-index: 2;">
                <button onclick="toggleDirection()" style="background: var(--bg); border: 1px solid var(--border); color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer;">â‡…</button>
            </div>

            <div class="swap-box">
                <span style="font-size: 10px; color: #555;" id="label-to">TO: RABx</span>
                <input type="number" class="swap-input" id="swap-out" readonly placeholder="0.0" style="color: var(--accent)">
            </div>

            <button class="btn btn-outline" style="margin-top: 10px;" onclick="executeAdvancedSwap()">Execute Conversion</button>
        </div>
    </div>

    <div id="debug-console">>> IDLE: Awaiting user...</div>
</div>

<script>
    // --- RAGNATELA DINAMICA ---
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function initCanvas() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        particles = [];
        for (let i = 0; i < 80; i++) {
            particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5 });
        }
    }
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy;
            if (p.x<0 || p.x>canvas.width) p.vx*=-1; if (p.y<0 || p.y>canvas.height) p.vy*=-1;
            ctx.beginPath(); ctx.arc(p.x, p.y, 1.2, 0, Math.PI*2); ctx.fill();
            for (let j=i+1; j<particles.length; j++) {
                let p2 = particles[j];
                let d = Math.hypot(p.x-p2.x, p.y-p2.y);
                if (d < 120) {
                    ctx.strokeStyle = `rgba(230, 0, 122, ${1 - d/120 - 0.8})`;
                    ctx.lineWidth = 0.5;
                    ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                }
            }
        });
        requestAnimationFrame(draw);
    }
    initCanvas(); draw(); window.onresize = initCanvas;

    // --- LOGIC ---
    const HOP_RAW = "0x5bf234923b9a947ad6770dad18a04f9ae33ad3bc";
    const SWAP_RAW = "0x73bde75a9b1e0a13b76624a51371f78fe579d478";
    let userAddr, isHopToRab = true;

    function dbg(m) { const c = document.getElementById('debug-console'); c.innerHTML += ">> " + m + "<br>"; c.scrollTop = c.scrollHeight; }
    function safeAddr(a) { return ethers.utils.getAddress(a.toLowerCase()); }

    async function forceNetwork() {
        try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: '0x190bc416', chainName: 'Paseo Asset Hub', nativeCurrency: { name: 'PAS', symbol: 'PAS', decimals: 18 }, rpcUrls: ['https://testnet-passet-hub-eth-rpc.polkadot.io'] }]}); dbg("NETWORK_SYNCED"); } catch (e) { dbg("NET_ERR"); }
    }

    async function forceConnect() {
        try { 
            const acc = await window.ethereum.request({ method: 'eth_requestAccounts' }); 
            userAddr = safeAddr(acc[0]); 
            document.getElementById('setup-screen').style.display='none'; 
            document.getElementById('terminal-screen').style.display='grid'; 
            refreshBalances();
            dbg("NODE_CONNECTED"); 
        } catch (e) { dbg("LINK_ERR"); }
    }

    // --- SMART ACTION: CLAIM OR POH ---
    async function handleClaimState() {
        dbg("INSPECTING_BLOCKCHAIN...");
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const contract = new ethers.Contract(safeAddr(HOP_RAW), ["function lastClaim(address) view returns (uint256)"], provider);
            const last = await contract.lastClaim(userAddr);
            const next = parseInt(last) + 604800;
            const now = Math.floor(Date.now() / 1000);

            if (now < next && parseInt(last) !== 0) {
                startCountdown(next);
            } else {
                startPoh();
            }
        } catch (e) { dbg("SCAN_ERR"); }
    }

    function startCountdown(target) {
        document.getElementById('btn-main-action').style.display = 'none';
        const box = document.getElementById('countdown-box');
        box.style.display = 'block';
        setInterval(() => {
            const diff = target - Math.floor(Date.now() / 1000);
            if (diff <= 0) location.reload();
            const d = Math.floor(diff/86400), h = Math.floor((diff%86400)/3600), m = Math.floor((diff%3600)/60), s = diff%60;
            box.innerText = `NEXT CLAIM IN: ${d}D ${h}H ${m}M ${s}S`;
        }, 1000);
    }

    function startPoh() {
        document.getElementById('btn-main-action').style.display = 'none';
        document.getElementById('poh-container').style.display = 'block';
        const icons = ['ðŸ°', 'ðŸ’Ž', 'ðŸ”¥', 'âš¡', 'ðŸŒ€', 'ðŸš€', 'ðŸŒ‘', 'ðŸ›¡ï¸'];
        const seq = icons.sort(() => 0.5 - Math.random()).slice(0, 4);
        document.getElementById('poh-display').innerText = seq.join(' ');
        const grid = document.getElementById('poh-grid'); grid.innerHTML = '';
        let step = 0;
        icons.sort(() => 0.5 - Math.random()).forEach(icon => {
            const c = document.createElement('div'); c.className = 'poh-cell'; c.innerText = icon;
            c.onclick = () => {
                if(icon === seq[step]) {
                    step++; c.style.opacity = '0.2';
                    if(step === 4) {
                        document.getElementById('poh-container').style.display = 'none';
                        document.getElementById('btn-final-claim').style.display = 'block';
                        dbg("HUMAN_VERIFIED");
                    }
                } else { startPoh(); }
            };
            grid.appendChild(c);
        });
    }

    async function manualClaim() {
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const contract = new ethers.Contract(safeAddr(HOP_RAW), ["function claimToken() external"], provider.getSigner());
            const tx = await contract.claimToken();
            await tx.wait();
            location.reload();
        } catch (e) { dbg("CLAIM_ERR"); }
    }

    // --- SWAP LOGIC ---
    async function refreshBalances() {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const hop = new ethers.Contract(safeAddr(HOP_RAW), ["function balanceOf(address) view returns (uint256)"], provider);
        const b = await hop.balanceOf(userAddr);
        document.getElementById('bal-from').innerText = parseFloat(ethers.utils.formatEther(b)).toFixed(2);
    }

    function setMax() {
        document.getElementById('swap-in').value = document.getElementById('bal-from').innerText;
        updateEstimate(document.getElementById('swap-in').value);
    }

    function updateEstimate(v) { document.getElementById('swap-out').value = isHopToRab ? (v * 200).toFixed(2) : (v / 200).toFixed(6); }

    function toggleDirection() {
        isHopToRab = !isHopToRab;
        document.getElementById('label-from').innerText = isHopToRab ? "FROM: HOPx" : "FROM: RABx";
        document.getElementById('label-to').innerText = isHopToRab ? "TO: RABx" : "TO: HOPx";
    }

    async function executeAdvancedSwap() {
        const val = document.getElementById('swap-in').value;
        if(!val || val <= 0) return;
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(safeAddr(HOP_RAW), ["function sendToContract(address _target, uint256 _amount) external"], signer);
            const tx = await contract.sendToContract(safeAddr(SWAP_RAW), ethers.utils.parseEther(val.toString()), { gasLimit: 250000 });
            await tx.wait();
            dbg("SWAP_SUCCESSFUL");
            refreshBalances();
        } catch (e) { dbg("SWAP_ERR"); }
    }
</script>
</body>
</html>
